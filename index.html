<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Propiedades</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
    font-family: Arial, sans-serif;
    background: #f1f1f1;
    display: flex;
    justify-content: center;
    padding: 20px;
}

.container{
    background: white;
    width: 95%;
    max-width: 650px;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0px 0px 10px rgba(0,0,0,0.3);
    text-align: center;
}

h1, h2{
    margin-top: 20px;
    color: #333;
}

label{
    font-weight: bold;
    display: block;
    margin-top: 12px;
    text-align: left;
}

input, select, textarea{
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-top: 5px;
}

textarea{
    height: 70px;
}

#map{
    height: 300px;
    margin-top: 10px;
    border-radius: 8px;
}

button{
    width: 100%;
    padding: 12px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 8px;
    font-size: 17px;
    cursor: pointer;
    margin-top: 20px;
}

.btn-atras{
    background: gray;
}
</style>
</head>
<body>

<div class="container">

<h1>Registro de Propiedades</h1>

<h2>DATOS GENERALES</h2>

<label>ID de Formulario:</label>
<input type="text" id="idFormulario" readonly>

<label>Mapa (Latitud y Longitud)</label>
<div id="map"></div>

<label>Latitud:</label>
<input type="text" id="latitud" readonly>

<label>Longitud:</label>
<input type="text" id="longitud" readonly>

<label>Tipo de Propiedad:</label>
<select id="tipoPropiedad">
    <option value="Casa">Casa</option>
    <option value="Departamento">Departamento</option>
    <option value="Terreno">Terreno</option>
</select>

<label>Imágenes (máximo 5):</label>
<input type="file" id="imagenes" accept="image/*" multiple>

<h2>DATOS ALCALDÍA</h2>

<label>Contribuyente:</label>
<input type="text" id="contribuyente">

<label>N° de Inmueble:</label>
<input type="text" id="inmueble">

<label>Ubicación:</label>
<textarea id="ubicacion"></textarea>

<label>Superficie del Terreno:</label>
<input type="text" id="superficie">

<h2>DATOS DE DERECHOS REALES</h2>

<label>N° de Matrícula:</label>
<input type="text" id="matricula">

<label>Propietario Vigente:</label>
<input type="text" id="propietario">

<label>Restricciones Pendientes:</label>
<textarea id="restricciones"></textarea>

<label>Trámites Pendientes:</label>
<textarea id="tramites"></textarea>

<button onclick="enviarDatos()">Guardar Registro</button>
<button class="btn-atras">Atrás</button>

</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// ------------------ GENERAR ID ALEATORIO ------------------
document.getElementById("idFormulario").value = Math.floor(Math.random() * 900000) + 100000;

// ------------------ MAPA ------------------
var map = L.map('map').setView([-16.5, -68.15], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 19
}).addTo(map);

var marker;

map.on("click", function(e){
    var lat = e.latlng.lat.toFixed(6);
    var lng = e.latlng.lng.toFixed(6);
    document.getElementById("latitud").value = lat;
    document.getElementById("longitud").value = lng;

    if(marker){ marker.remove(); }
    marker = L.marker([lat, lng]).addTo(map);
});

// Convertir imagen a base64
function fileToBase64(file){
    return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

// ------------------ ENVIAR DATOS ------------------
async function enviarDatos(){

    const url = "https://script.google.com/macros/s/AKfycbzkpG9SznEaLOKdCVRwBtiO3ZFON1fBJw4C1qoOHqWAmJZfCz8YvH0YAZM1gu-VKYNb/exec";

    let datos = {
        idFormulario: document.getElementById("idFormulario").value,
        latitud: document.getElementById("latitud").value,
        longitud: document.getElementById("longitud").value,
        tipo: document.getElementById("tipoPropiedad").value,
        contribuyente: document.getElementById("contribuyente").value,
        inmueble: document.getElementById("inmueble").value,
        ubicacion: document.getElementById("ubicacion").value,
        superficie: document.getElementById("superficie").value,
        matricula: document.getElementById("matricula").value,
        propietario: document.getElementById("propietario").value,
        restricciones: document.getElementById("restricciones").value,
        tramites: document.getElementById("tramites").value
    };

    // Imágenes base64
    const files = document.getElementById("imagenes").files;
    for(let i=0; i < Math.min(files.length, 5); i++){
        datos["imagen_" + i] = await fileToBase64(files[i]);
    }

    try {
        const result = await fetch(url, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(datos)
        });

        const response = await result.json();

        if(response.status === "ok"){
            alert("Registro guardado correctamente ✔");
        } else {
            alert("Error: " + response.message);
        }

    } catch (error){
        alert("Error al conectar con el servidor (fetch): " + error);
    }
}
</script>

</body>
</html>
